# A2: 数据库架构设计方案

## 项目概述
基于A1阶段的前端文字内容分析，设计Supabase数据库架构，用于存储和管理网站中所有HTML组件的文字信息，实现内容的动态化管理。

## 现有数据库分析

### 当前表结构
1. **teachers** - 师资信息表
2. **email_logs** - 邮件日志表
3. **component_instances** - 组件实例表
4. **component_styles** - 组件样式表
5. **student_cases** - 学员案例表
6. **courses** - 课程信息表
7. **articles** - 文章信息表
8. **theme_configs** - 主题配置表

### 架构特点
- 已有完整的内容管理基础（课程、师资、案例、文章）
- 具备组件化管理能力（component_instances, component_styles）
- 支持主题配置和样式管理
- 使用UUID作为主键，支持RLS（行级安全）

## 新增表结构设计

### 1. 核心内容管理表

#### 1.1 site_content (网站内容表)
```sql
CREATE TABLE site_content (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  content_key VARCHAR(255) NOT NULL UNIQUE, -- 内容唯一标识符
  content_type VARCHAR(50) NOT NULL, -- 内容类型
  page_location VARCHAR(100) NOT NULL, -- 页面位置
  component_type VARCHAR(20) NOT NULL, -- HTML组件类型
  content_text TEXT NOT NULL, -- 文字内容
  content_html TEXT, -- HTML内容（如果需要富文本）
  language VARCHAR(10) DEFAULT 'zh-CN', -- 语言代码
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  -- 约束
  CONSTRAINT chk_content_type CHECK (content_type IN (
    'page_title', 'seo_description', 'navigation', 'button', 
    'section_title', 'section_description', 'status_message', 
    'error_message', 'form_label', 'placeholder', 'tooltip'
  )),
  
  CONSTRAINT chk_page_location CHECK (page_location IN (
    'homepage', 'courses', 'teachers', 'student_cases', 
    'articles', 'about', 'contact', 'global', 'error_pages'
  )),
  
  CONSTRAINT chk_component_type CHECK (component_type IN (
    'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'span', 
    'a', 'button', 'div', 'label', 'input', 'textarea'
  ))
);

-- 索引
CREATE INDEX idx_site_content_key ON site_content(content_key);
CREATE INDEX idx_site_content_type_page ON site_content(content_type, page_location);
CREATE INDEX idx_site_content_active ON site_content(is_active, sort_order);
```

#### 1.2 navigation_items (导航项目表)
```sql
CREATE TABLE navigation_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nav_key VARCHAR(100) NOT NULL UNIQUE, -- 导航唯一标识
  nav_type VARCHAR(50) NOT NULL, -- 导航类型
  label_text VARCHAR(255) NOT NULL, -- 显示文字
  href_url VARCHAR(500), -- 链接地址
  icon_name VARCHAR(100), -- 图标名称
  parent_id UUID REFERENCES navigation_items(id), -- 父级导航
  is_external BOOLEAN DEFAULT false, -- 是否外部链接
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  -- 约束
  CONSTRAINT chk_nav_type CHECK (nav_type IN (
    'main_nav', 'footer_nav', 'breadcrumb', 'sidebar_nav', 
    'mobile_nav', 'quick_links', 'social_links'
  ))
);

-- 索引
CREATE INDEX idx_navigation_type ON navigation_items(nav_type, is_active, sort_order);
CREATE INDEX idx_navigation_parent ON navigation_items(parent_id);
```

#### 1.3 ui_text_elements (UI文字元素表)
```sql
CREATE TABLE ui_text_elements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  element_key VARCHAR(255) NOT NULL UNIQUE, -- 元素唯一标识
  element_category VARCHAR(50) NOT NULL, -- 元素分类
  element_context VARCHAR(100) NOT NULL, -- 使用上下文
  text_content TEXT NOT NULL, -- 文字内容
  alt_text TEXT, -- 替代文字
  tooltip_text TEXT, -- 提示文字
  aria_label TEXT, -- 无障碍标签
  language VARCHAR(10) DEFAULT 'zh-CN',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  -- 约束
  CONSTRAINT chk_element_category CHECK (element_category IN (
    'button', 'label', 'placeholder', 'tooltip', 'alert', 
    'modal', 'form_validation', 'loading', 'empty_state', 
    'error_state', 'success_state'
  )),
  
  CONSTRAINT chk_element_context CHECK (element_context IN (
    'form', 'navigation', 'content', 'feedback', 'action', 
    'status', 'search', 'filter', 'pagination', 'modal'
  ))
);

-- 索引
CREATE INDEX idx_ui_text_category ON ui_text_elements(element_category, element_context);
CREATE INDEX idx_ui_text_active ON ui_text_elements(is_active);
```

#### 1.4 page_sections (页面区块表)
```sql
CREATE TABLE page_sections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  section_key VARCHAR(255) NOT NULL UNIQUE, -- 区块唯一标识
  page_location VARCHAR(100) NOT NULL, -- 页面位置
  section_name VARCHAR(255) NOT NULL, -- 区块名称
  section_title TEXT, -- 区块标题
  section_subtitle TEXT, -- 区块副标题
  section_description TEXT, -- 区块描述
  section_cta_text TEXT, -- 行动召唤文字
  section_cta_url VARCHAR(500), -- 行动召唤链接
  background_config JSONB DEFAULT '{}', -- 背景配置
  layout_config JSONB DEFAULT '{}', -- 布局配置
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  -- 约束
  CONSTRAINT chk_page_location_sections CHECK (page_location IN (
    'homepage', 'courses', 'teachers', 'student_cases', 
    'articles', 'about', 'contact'
  ))
);

-- 索引
CREATE INDEX idx_page_sections_location ON page_sections(page_location, is_active, sort_order);
```

#### 1.5 seo_metadata (SEO元数据表)
```sql
CREATE TABLE seo_metadata (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  page_path VARCHAR(500) NOT NULL UNIQUE, -- 页面路径
  page_title VARCHAR(255) NOT NULL, -- 页面标题
  meta_description TEXT, -- 页面描述
  meta_keywords TEXT, -- 关键词
  og_title VARCHAR(255), -- Open Graph标题
  og_description TEXT, -- Open Graph描述
  og_image_url VARCHAR(500), -- Open Graph图片
  twitter_title VARCHAR(255), -- Twitter标题
  twitter_description TEXT, -- Twitter描述
  canonical_url VARCHAR(500), -- 规范URL
  robots_meta VARCHAR(100) DEFAULT 'index,follow', -- 爬虫指令
  language VARCHAR(10) DEFAULT 'zh-CN',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- 索引
CREATE INDEX idx_seo_path ON seo_metadata(page_path, is_active);
```

### 2. 多语言支持表

#### 2.1 content_translations (内容翻译表)
```sql
CREATE TABLE content_translations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source_table VARCHAR(100) NOT NULL, -- 源表名
  source_id UUID NOT NULL, -- 源记录ID
  source_field VARCHAR(100) NOT NULL, -- 源字段名
  language VARCHAR(10) NOT NULL, -- 目标语言
  translated_text TEXT NOT NULL, -- 翻译文字
  translation_status VARCHAR(20) DEFAULT 'pending', -- 翻译状态
  translator_id UUID, -- 翻译者ID
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  -- 约束
  CONSTRAINT chk_translation_status CHECK (translation_status IN (
    'pending', 'in_progress', 'completed', 'reviewed', 'rejected'
  )),
  
  -- 唯一约束
  UNIQUE(source_table, source_id, source_field, language)
);

-- 索引
CREATE INDEX idx_translations_source ON content_translations(source_table, source_id, language);
```

### 3. 内容版本管理表

#### 3.1 content_versions (内容版本表)
```sql
CREATE TABLE content_versions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  content_table VARCHAR(100) NOT NULL, -- 内容表名
  content_id UUID NOT NULL, -- 内容ID
  version_number INTEGER NOT NULL, -- 版本号
  content_data JSONB NOT NULL, -- 版本内容数据
  change_description TEXT, -- 变更描述
  changed_by UUID, -- 变更人
  change_type VARCHAR(50) DEFAULT 'update', -- 变更类型
  is_published BOOLEAN DEFAULT false, -- 是否已发布
  created_at TIMESTAMPTZ DEFAULT now(),
  
  -- 约束
  CONSTRAINT chk_change_type CHECK (change_type IN (
    'create', 'update', 'delete', 'restore', 'publish', 'unpublish'
  )),
  
  -- 唯一约束
  UNIQUE(content_table, content_id, version_number)
);

-- 索引
CREATE INDEX idx_content_versions ON content_versions(content_table, content_id, version_number DESC);
```

## 数据映射策略

### 1. 内容分类映射

#### 页面标题映射
```
首页 -> site_content
- content_key: 'homepage_hero_title'
- content_type: 'section_title'
- page_location: 'homepage'
- component_type: 'h1'
- content_text: '实现你的名校梦想'
```

#### 导航链接映射
```
主导航 -> navigation_items
- nav_key: 'main_nav_home'
- nav_type: 'main_nav'
- label_text: '首页'
- href_url: '/'
```

#### UI元素映射
```
按钮文字 -> ui_text_elements
- element_key: 'btn_view_courses'
- element_category: 'button'
- element_context: 'action'
- text_content: '查看课程'
```

### 2. 页面区块映射

#### 首页区块
```
Hero区块 -> page_sections
- section_key: 'homepage_hero'
- page_location: 'homepage'
- section_title: '实现你的名校梦想'
- section_description: '专业的考研培训机构，提供全方位的考研辅导服务，助你一次上岸'
- section_cta_text: '查看课程'
```

## 数据迁移计划

### 阶段1：表结构创建
1. 创建所有新表结构
2. 设置索引和约束
3. 配置RLS策略

### 阶段2：数据导入
1. 从前端代码提取文字内容
2. 按分类整理并导入数据
3. 建立内容关联关系

### 阶段3：前端集成
1. 创建内容获取API
2. 修改前端组件使用动态内容
3. 实现内容管理界面

## API设计建议

### 1. 内容获取API
```typescript
// 获取页面内容
GET /api/content/page/{page_location}

// 获取特定内容
GET /api/content/item/{content_key}

// 获取导航项目
GET /api/navigation/{nav_type}

// 获取UI文字
GET /api/ui-text/{element_category}
```

### 2. 内容管理API
```typescript
// 更新内容
PUT /api/content/{content_id}

// 批量更新
POST /api/content/batch-update

// 版本管理
GET /api/content/{content_id}/versions
POST /api/content/{content_id}/publish
```

## 性能优化策略

### 1. 缓存策略
- Redis缓存常用内容
- CDN缓存静态内容
- 浏览器缓存策略

### 2. 查询优化
- 合理使用索引
- 批量查询减少请求
- 分页加载大量数据

### 3. 数据预加载
- 页面级内容预加载
- 关键路径内容优先
- 懒加载非关键内容

## 安全考虑

### 1. 权限控制
- RLS策略控制数据访问
- 角色权限管理
- 内容审核机制

### 2. 数据验证
- 输入内容验证
- XSS防护
- SQL注入防护

### 3. 版本控制
- 内容变更记录
- 回滚机制
- 审计日志

## 扩展性设计

### 1. 多语言支持
- 完整的翻译管理
- 语言切换机制
- 本地化内容

### 2. 个性化内容
- 用户偏好设置
- A/B测试支持
- 动态内容推荐

### 3. 内容分发
- 多环境部署
- 内容同步机制
- 版本发布管理

## 监控和维护

### 1. 性能监控
- 查询性能监控
- 缓存命中率
- API响应时间

### 2. 内容质量
- 内容完整性检查
- 链接有效性验证
- 多语言一致性

### 3. 用户体验
- 加载时间监控
- 错误率统计
- 用户反馈收集

## 总结

本设计方案提供了完整的内容管理数据库架构，支持：
- 全面的文字内容管理
- 灵活的多语言支持
- 完善的版本控制
- 高性能的内容分发
- 安全的权限管理

通过这套架构，可以实现前端网站内容的完全动态化，提升内容管理效率和用户体验。

---
**设计完成时间**: 2024年12月19日  
**设计人员**: AI助理  
**状态**: 设计完成，待审批